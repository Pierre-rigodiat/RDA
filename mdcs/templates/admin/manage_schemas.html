<!-- 
################################################################################
#
# File Name: manage_schemas.html
# Application: templates/admin
# Description: 
#
# Author: Sharief Youssef
#         sharief.youssef@nist.gov
#
# Sponsor: National Institute of Standards and Technology (NIST)
#
################################################################################
-->

{% load staticfiles %}

{% load dajaxice_templatetags %}

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr">

<head>
	<meta http-equiv="content-type" content="text/html; charset=UTF-8"/>
	<meta name="description" content=""/>
	<meta name="keywords" content="" />
	<meta name="author" content="" />
	<link rel="stylesheet" type="text/css" href="{% static 'resources/css/lib/bootstrap.min.css' %}"  media="screen" />
	<link rel="stylesheet" type="text/css" href="{% static 'style.css' %}" media="screen" />
	<title>Materials Data Curation System</title>

<link rel="stylesheet" type="text/css" href="{% static 'admin/css/dashboard.css' %}" />
<link rel="stylesheet" type="text/css" href="{% static 'resources/css/style.add.css' %}" media="screen" />
<link rel="stylesheet" type="text/css" href="{% static 'resources/css/xml_display.css' %}" media="screen" />
<link rel="stylesheet" type="text/css" href="{% static 'resources/css/icons.css' %}" media="screen" />
<link rel="stylesheet" type="text/css" href="{% static 'resources/css/table.css' %}" media="screen" />
<link rel="stylesheet" type="text/css" href="{% static 'resources/css/table.add.css' %}" media="screen" />
<link rel="stylesheet" type="text/css" href="{% static 'resources/css/dialog.css' %}" media="screen" />

	<!-- JQuery & JQuery UI -->
        <link rel="stylesheet" href="http://code.jquery.com/ui/1.10.3/themes/smoothness/jquery-ui.css">
        <script src="http://code.jquery.com/jquery-1.9.1.js"></script>
        <script src="http://code.jquery.com/ui/1.10.3/jquery-ui.js"></script>
	<script src="{% static 'dajax/jquery.dajax.core.js' %}"></script>

        {% dajaxice_js_import %}
</head>

<body id="top">

<div id="content-main">

<div id="header-wrapper">
	<div id="header-wrapper-2">
		<div class="center-wrapper">

			<div id="header">


				<div id="logo">


					<h1 id="site-title"><a href="/admin">Materials Data <span>Curation Administration</span></a></h1>
					<h2 id="site-slogan">
{% if user.is_authenticated %}
    Welcome, {{ user.username }}. Thanks for logging in.
{% else %}
    Part of the Materials Genome Initiative
{% endif %}
</h2>
				</div>

				<div id="help-wrapper">
					<div id="help" align="center">
<nobr>
{% if user.is_authenticated %}
    <a href="/logout">Logout</a> 
{% else %}
    <a href="/login">Login</a> 
{% endif %}

<span class="text-separator">|</span> <a href="/my-profile">My Profile</a> <span class="text-separator">|</span> <a href="/help">Help</a> 
</nobr>

					</div>
				</div>

			</div>

		</div>
	</div>
</div>

<div id="navigation-wrapper">
	<div id="navigation-wrapper-2">
		<div class="center-wrapper">
	
			<div id="navigation">

				<ul class="tabbed">
					<li><a href="/">Home</a></li>
					<li><a href="/admin/user-management">User Management</a></li>
					<li class="current_page_item"><a href="/admin/xml-schemas">XML Schemas & Ontologies</a></li>
				</ul>

				<div class="clearer">&nbsp;</div>

			</div>

		</div>
	</div>
</div>



<div id="subnav-wrapper">
  <div id="subnav-wrapper-2">

    <div class="center-wrapper">
      
      <div id="subnav">

	<ul class="tabbed">
	  <li><a href="/admin/xml-schemas/current-model">Current Model</a></li>
	  <li class="current_page_item"><a href="/admin/xml-schemas/manage-schemas">Manage Schemas</a></li>
	  <li><a href="/admin/xml-schemas/manage-ontologies">Manage Ontologies</a></li>
<!--	  <li><a href="/admin/xml-schemas/manage-modules">Manage Modules</a></li> -->
	  </ul>

	<div class="clearer">&nbsp;</div>

	</div>

      </div>
    </div>
</div>


<div id="content-wrapper">
	<div class="center-wrapper">
		
		<div class="content">

			<div id="featured-wrapper">
				<div id="featured">

<h1>Schema Manager</h1>
					
					<div class="clearer">&nbsp;</div>

				</div>
			</div>

			<div id="main">

<div class="right-side">
<span class="ctx_menu"> 
<!-- <div class="icon legend long copy schema">Copy schema</div> -->
<div class="icon legend long upload schema">Upload schema</div>
</span>
</div>

		      <div id="model_selection">
		      
{% if request.session.currentTemplate %} 

{% else %}

<!-- <div class="warn"><div class="icon warning"></div>The system has no schema loaded. Please set a current model to allow user to use the repository.</div> -->

{% endif %}

<table class="data-table">
  <tr>
    <th>Schema name</th>
    <th>Filename</th>
    <th>Status</th>
    <th>Actions</th>
  </tr>


{% for template in templates %}
  {% cycle 'even' '' as rowcolors silent %}
  <tr class="{{ rowcolors }}">
    <td>{{ template.title }}</td>
    <td>{{ template.filename }}</td>

{% if request.session.currentTemplate == template.filename %} 

    <!--<td><span style="color:blue;font-weight:bold">Current model</span></td>
    <td><div class="icon legend delete schema" schemaid="{{ template.id }}">Delete</div></td>-->
	<td><span style="color:green;">Registered</span></td>
	<td>
    <div class="icon legend long version" schemaid="{{ template.id }}">Manage Versions</div>
    <div class="icon legend long copy schema">Copy schema</div>
    <div class="icon legend delete schema" schemaid="{{ template.id }}">Delete Schema</div></td>
{% else %}

    <td><span style="color:green;">Registered</span></td>
    <td>
    <!-- <div class="icon legend extra-long add">Set as current model</div> -->
    <div class="icon legend long version" schemaid="{{ template.id }}">Manage Versions</div>
    <div class="icon legend long copy schema">Copy schema</div>
    <div class="icon legend delete schema" schemaid="{{ template.id }}">Delete Schema</div></td>

{% endif %}

  </tr>

{% endfor %}

</table>

<div id="dialog-message" title="Template Loaded" style="display:none;">
<p></p>
  <p>
    <span class="ui-icon ui-icon-circle-check" style="float:left; margin:0 7px 10px 0;"></span>
    Template selected successfully. 
  </p>
  <p>
    Currently using <a href="/view-schema/{{ request.session.currentTemplate }}" target="_new">{{ request.session.currentTemplate }}</a>
  </p>
  <p>
    To proceed to the next step, click on step 2: <b>'Enter Data'</b>
  </p>
</div>


</div>



<div class="right-side">
<span class="ctx_menu">
<!-- <div class="icon legend long copy schema">Copy schema</div> -->
<div class="icon legend long upload schema">Upload schema</div>
</span>
</div>

			</div>

		</div>

	</div>
</div>

<div id="footer-wrapper">

	<div class="center-wrapper">

		<div id="footer2">

			<div class="left">
				<a href="/admin">Home</a> <span class="text-separator">|</span> <a href="/admin/user-management">User Management</a> <span class="text-separator">|</span> <a href="/admin/xml-schemas">XML Schemas & Ontologies</a> <span class="text-separator">|</span> <a href="/about">About</a> <span class="text-separator">|</span> <a href="/contact">Contact</a> 
			</div>

			<div class="right">
				<a href="#">Top ^</a>
			</div>
			
			<div class="clearer">&nbsp;</div>

		</div>

	</div>

</div>

<div id="bottom">

	<div class="center-wrapper">

		<div class="left">
			&copy; 2012 - {{ request.session.currentYear }} Materials Data Curation System <span class="text-separator">|</span> <a href="/privacy-policy">Privacy Policy</a> <span class="text-separator">|</span> <a href="/terms-of-use">Terms of Use</a> 
		</div>

		<div class="right">
			<a href="http://templates.arcsin.se/">Website template</a> by <a href="http://arcsin.se/">Arcsin</a> 
		</div>
		
		<div class="clearer">&nbsp;</div>

	</div>

</div>

<script src="{% static 'resources/js/bootstrap.min.js' %}"></script>
<script src="{% static 'inc/controllers/js/xsd_mgr.js' %}"></script>
<script>
  loadXsdManagerHandler();
</script>


<div id="dialog-currentmodel-message" title="Model Selection Successful" style="display:none;">
<p></p>
  <p>
    <span class="ui-icon ui-icon-circle-check" style="float:left; margin:0 7px 10px 0;"></span>
    Current model selected successfully. 
  </p>
  <p>
    Currently using <a href="/view-schema/{{ request.session.currentTemplate }}" target="_new">{{ request.session.currentTemplate }}</a>
  </p>
</div>

<div id="dialog-copied-message" title="Copy Successful" style="display:none;">
<p></p>
  <p>
    <span class="ui-icon ui-icon-circle-check" style="float:left; margin:0 7px 10px 0;"></span>
    Schema copied successfully. 
  </p>
  <p>
    Currently using <a href="/view-schema/{{ request.session.currentTemplate }}" target="_new">{{ request.session.currentTemplate }}</a>
  </p>
</div>

<div id="dialog-manage-versions" title="Manage Schema Versions" style="display:none;">  
  <p>
  <div id="template_versions">
  </div>
  </p>
</div>

<style>
  #progress_bar {
    margin: 10px 0;
    padding: 3px;
    border: 1px solid #000;
    font-size: 14px;
    clear: both;
    opacity: 0;
    -moz-transition: opacity 1s linear;
    -o-transition: opacity 1s linear;
    -webkit-transition: opacity 1s linear;
  }
  #progress_bar.loading {
    opacity: 1.0;
  }
  #progress_bar .percent {
    background-color: #99ccff;
    height: auto;
    width: 0;
  }
</style>

<div id="dialog-upload-message" title="Upload Schema" style="display:none;">
<br>
Enter a Schema name: <input type="text" id="schema_name" name="schema_name"/>
<br>
<input type="file" id="files" name="files[]" multiple />
<output id="list"></output>
<div id="schemaNameErrorMessage"></div>
<script>
  var files;
//  var reader;
//  var progress = document.querySelector('.percent');

  function errorHandler(evt) {
    switch(evt.target.error.code) {
      case evt.target.error.NOT_FOUND_ERR:
        alert('File Not Found!');
        break;
      case evt.target.error.NOT_READABLE_ERR:
        alert('File is not readable');
        break;
      case evt.target.error.ABORT_ERR:
        break; // noop
      default:
        alert('An error occurred reading this file.');
    };
  }

  function updateProgress(evt) {
    // evt is an ProgressEvent.
    if (evt.lengthComputable) {
      var percentLoaded = Math.round((evt.loaded / evt.total) * 100);
      // Increase the progress bar length.
      if (percentLoaded < 100) {
        progress.style.width = percentLoaded + '%';
        progress.textContent = percentLoaded + '%';
      }
    }
  }

  function uploadXMLSchemaCallback(data) {
    console.log('BEGIN uploadXMlSchemaCallback');

    Dajax.process(data);
    console.log('BEGIN [setCurrentModelCallback]');
//    location.reload();

//    var messageLocation = $("#main").children(":first");
//    messageLocation.hide().html("Template Successfully Selected").fadeIn(500);
//    messageLocation.delay(2000).fadeOut(500);

    $('#model_selection').load(document.URL +  ' #model_selection', function() {
			  loadXsdManagerHandler();
			  //displayModelSelectedDialog();
    });
    console.log('END [setCurrentModelCallback]');

    console.log('END uploadXMlSchemaCallback');
  }

  function handleFileUpload(evt) {
    console.log('BEGIN handleFileUpload(evt)');

    if (document.getElementById("schema_name").value.trim().length == 0) {
        document.getElementById('schemaNameErrorMessage').innerHTML = "<font color=\"red\">Please enter a schema name</font>"
        return false;
    } else {
        document.getElementById('schemaNameErrorMessage').innerHTML = ""
    }

    var reader;
    var progress = document.querySelector('.percent');

    document.getElementById('uploadFile').disabled = true;

    // Reset progress indicator on new file selection.
    progress.style.width = '0%';
    progress.textContent = '0%';

    reader = new FileReader();
    reader.onerror = errorHandler;
    reader.onprogress = updateProgress;
    reader.onabort = function(e) {
      alert('File read cancelled');
    };
    reader.onloadstart = function(e) {
      document.getElementById('progress_bar').className = 'loading';
    };
    reader.onload = function(e) {
      // Ensure that the progress bar displays 100% at the end.
      progress.style.width = '100%';
      progress.textContent = '100%';
//      setTimeout("document.getElementById('progress_bar').className='';", 2000);

      var xmlSchemaName = document.getElementById('schema_name').value.trim();

      Dajaxice.curate.uploadXMLSchema(uploadXMLSchemaCallback,{'xmlSchemaName':xmlSchemaName,'xmlSchemaFilename':files[0].name,'xmlSchemaContent':reader.result}); 
    }

    // Read in the image file as a binary string.
    reader.readAsText(files[0]);

    console.log('END handleFileUpload(evt)');
  }

  function handleFileSelect(evt) {
    files = evt.target.files; // FileList object

    // files is a FileList of File objects. List some properties.
    var output = [];
    for (var i = 0, f; f = files[i]; i++) {
//      output.push('<li><strong>', escape(f.name), '</strong> (', f.type || 'n/a', ') - ',
//                  f.size, ' bytes, last modified: ',
//                  f.lastModifiedDate ? f.lastModifiedDate.toLocaleDateString() : 'n/a',
//                  '</li><button id=\'uploadFile\'>Upload</button><div id=\"progress_bar\"><div class=\"percent\">0%</div></div>');
      output.push('<br></li><button id=\'uploadFile\'>Upload</button><div id=\"progress_bar\"><div class=\"percent\">0%</div></div>');
    }
    document.getElementById('list').innerHTML = '<ul>' + output.join('') + '</ul>';
    document.getElementById('uploadFile').disabled = false;
    document.getElementById('uploadFile').addEventListener('click', handleFileUpload, false);
  }

  document.getElementById('files').addEventListener('change', handleFileSelect, false);
</script>
</div>

<div id="dialog-deleteconfirm-message" title="Confirm Delete" style="display:none;">
<p></p>
  <p>
    <span class="ui-icon ui-icon-circle-check" style="float:left; margin:0 7px 10px 0;"></span>
    Are you sure you want to delete <b id="schema-to-delete"></b>?
  </p>
</div>


<div id="dialog-deleteversion-message" title="Confirm Delete" style="display:none;">
<p></p>
  <p>
    <span class="ui-icon ui-icon-circle-check" style="float:left; margin:0 7px 10px 0;"></span>
    Are you sure you want to delete this version?
  </p>
</div>


<script>
// Check for the various File API support.
if (window.File && window.FileReader && window.FileList && window.Blob) {
  // Great success! All the File APIs are supported.
  // alert('The File APIs are fully supported in this browser.');
} else {
  alert('The File APIs are not fully supported in this browser.');
}
</script>

</body>
</html>
